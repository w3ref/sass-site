<!DOCTYPE html> <html class=no-js lang=ru> <head> <meta charset=utf-8> <meta content='IE=edge' http-equiv=X-UA-Compatible> <title>Sass: The Discontinuation of node-fibers</title> <meta content='Syntactically Awesome Style Sheets' name=description> <meta content='width=device-width, initial-scale=1' name=viewport> <link href='/feed.xml' rel=alternate type='application/atom+xml'> <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,600|Source+Serif+Pro" rel=stylesheet /> <link href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" rel=stylesheet /> <link href="/assets/css/sass-dfc221cc.css" rel=stylesheet /> <noscript><link href="/assets/css/noscript-c6723936.css" rel=stylesheet /></noscript> <script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PCCZT7S');
</script> </head> <body class='blog blog_node-fibers-discontinued'> <noscript> <iframe height=0 src='https://www.googletagmanager.com/ns.html?id=GTM-PCCZT7S' style='display:none;visibility:hidden' width=0></iframe> </noscript> <!--[if lt IE 9]><p class=browserupgrade> You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security. </p><![endif]--> <header class=sl-r-banner itemscope=itemscope itemtype='http://schema.org/WPHeader' role=banner> <div class=sl-c-pop-stripe></div> <div class=sl-l-container> <div class='sl-l-grid sl-l-grid--full sl-l-large-grid--fit sl-l-large-grid--center sl-l-large-grid--gutters'> <p class='sl-l-grid__column sl-r-banner__brand'> <a href="/"><img alt=Sass height=48 src="/assets/img/logos/logo-b6e1ef6e.svg"/> </a></p> <nav aria-label='Site navigation' class='sl-r-banner__navigation sl-l-grid__column sl-l-large-grid sl-l-large-grid__column--auto-size sl-c-list-horizontal-wrapper' itemscope=itemscope itemtype='http://schema.org/SiteNavigationElement' role=navigation> <ul> <li><a href="/install">Установить</a></li> <li><a href="/guide">Изучить Sass</a></li> <li><a href="/blog">Блог</a></li> <li><a href="/documentation">Документация</a></li> <li><a href="/community">Участвовать</a></li> <li><label class=visuallyhidden for=s>Поиск</label><input placeholder='Искать' class=search id=s name=s></li> </ul> </nav> </div> </div> </header> <main class=content id=main-content itemprop=mainContentOfPage role=main> <h1 class=sl-l-container> The Discontinuation of&nbsp;node-fibers </h1> <div class='sl-background--white sl-l-container sl-l-section'><p class=sl-c-attribution>Posted 26 March 2021 by Natalie Weizenbaum</p> <p>We have recently received the unfortunate but not entirely surprising news&nbsp;that <a href="https://github.com/laverdet/node-fibers/commit/8f2809869cc92c28c92880c4a38317ae3dbe654d">the <code>node-fibers</code> package has reached its end-of-life</a> and will not be&nbsp;updated for compatibility with Node 16. Dart Sass has historically allowed&nbsp;JavaScript users to pass in <code>node-fibers</code> to improve the performance of the&nbsp;asynchronous <code>render()</code> method, but going forward this will unfortunately no longer be&nbsp;an option in Node 16 and&nbsp;on.</p> <p>There are a number of <a href="#reclaiming-performance">alternative options</a> for reclaiming this&nbsp;lost performance, some of them which are available today, some which are&nbsp;in development, and some which are theoretical but could be made real with&nbsp;pull requests from users like you. Sadly, none of the options that are ready&nbsp;today are drop-in solutions with the same level of ease-of-use as <code>node-fibers</code>, so&nbsp;if that performance is crucial to you we recommend staying on Node 14 for the&nbsp;time being.</p> <h2 id=what-happened> <a class=anchor href="#what-happened"><span class=visuallyhidden>What Happened? permalink</span></a>What&nbsp;Happened?</h2> <p>In order to understand how we got here, it&rsquo;s important to know two pieces&nbsp;of history. First, why does Dart Sass use <code>node-fibers</code> in the first place?&nbsp;And second, why is <code>node-fibers</code>&nbsp;dying?</p> <p><em>This section is fairly technical, so feel free to <a href="#reclaiming-performance">skip ahead</a> if you don&rsquo;t&nbsp;care about the gory&nbsp;details.</em></p> <h3 id=fibers-in-sass> <a class=anchor href="#fibers-in-sass"><span class=visuallyhidden>Fibers in Sass permalink</span></a>Fibers in&nbsp;Sass</h3> <p>Dart Sass inherited its <a href="/documentation/js-api">JavaScript <span class=caps>API</span></a> from the now-deprecated <a href="https://www.npmjs.com/package/node-sass">Node Sass</a>. This <span class=caps>API</span> has two main functions for compiling Sass files: <code>renderSync()</code>&nbsp;which synchronously returned the compiled <span class=caps>CSS</span>, and <code>render()</code> which instead takes&nbsp;a callback to which it passes the compiled <span class=caps>CSS</span> asynchronously. Only&nbsp;<code>render()</code> allowed asynchronous plugins, including widely-used importers such as&nbsp;webpack&rsquo;s <a href="https://www.npmjs.com/package/sass-loader"><code>sass-loader</code></a>, so <code>render()</code> became very widely used in&nbsp;practice.</p> <p>For Node Sass, the performance difference between <code>render()</code> and&nbsp;<code>renderSync()</code> was negligible, because it was built on C++ code which had few restrictions&nbsp;on how it handled asynchrony. However, Dart Sass runs as pure JavaScript,&nbsp;which makes it subject to JavaScript&rsquo;s strict async rules. Asynchrony in JavaScript&nbsp;is <em>contagious</em>, which means that if any function (such as an importer plugin)&nbsp;is asynchronous, then everything that calls it must be asynchronous, and so&nbsp;on until the entire program is&nbsp;asynchronous.</p> <p>And asynchrony in JavaScript isn&rsquo;t free. Every asynchronous function call has&nbsp;to allocate callbacks, store them somewhere, and take a trip back to the event&nbsp;loop before invoking those callbacks, and that all takes time. In fact, it&nbsp;takes enough time that the asynchronous <code>render()</code> in Dart Sass tends to be&nbsp;2-3x slower than&nbsp;<code>renderSync()</code>.</p> <p>Enter fibers. Fibers are a very cool concept, available in languages like&nbsp;Ruby and C++, that give the programmer more control over asynchronous functions.&nbsp;They can even allow a chunk of synchronous code (such as the Sass compiler) to&nbsp;call asynchronous callbacks (such as the webpack plugin). The <code>node-fibers</code>&nbsp;package did some arcane magick with the <span class=caps>V8</span> virtual machine to implement Fibers&nbsp;in JavaScript, which allowed Dart Sass to use the fast synchronous code&nbsp;to implement the asynchronous <code>render()</code> <span class=caps>API.</span> And for a time, it was&nbsp;great.</p> <h3 id=the-death-of-fibers> <a class=anchor href="#the-death-of-fibers"><span class=visuallyhidden>The Death of Fibers permalink</span></a>The Death of&nbsp;Fibers</h3> <p>Unfortunately, the arcane magick that <code>node-fibers</code> used involved accessing&nbsp;some parts of <span class=caps>V8</span> that were not officially part of its public <span class=caps>API.</span> There was&nbsp;no guarantee that the interfaces they were using would stay the same from&nbsp;release to release, and indeed they tended to change fairly regularly. For a long&nbsp;time, those changes were small enough that it was possible to release a new version&nbsp;of <code>node-fibers</code> that supported them, but with Node.js 16 the luck ran&nbsp;out.</p> <p>The latest version of <span class=caps>V8</span> involves some major overhauls to its internals.&nbsp;These will eventually allow it to implement some cool improvements, so its hard&nbsp;to begrudge, but a side effect is that the APIs <code>node-fibers</code> was using&nbsp;are completely gone without an obvious replacement. This is no one&rsquo;s fault:&nbsp;since those interfaces weren&rsquo;t part of <span class=caps>V8</span>&rsquo;s public <span class=caps>API</span>, they were under no&nbsp;obligation to keep them stable. Sometimes in software that&rsquo;s just the way things&nbsp;go.</p> <h2 id=reclaiming-performance> <a class=anchor href="#reclaiming-performance"><span class=visuallyhidden>Reclaiming Performance permalink</span></a>Reclaiming&nbsp;Performance</h2> <p>There are a few options for getting back the performance that&rsquo;s lost by&nbsp;no longer being able to pass <code>node-fibers</code> to <code>sass.render()</code>. In order&nbsp;from nearest to longest&nbsp;term:</p> <h3 id=avoid-asynchronous-plugins> <a class=anchor href="#avoid-asynchronous-plugins"><span class=visuallyhidden>Avoid Asynchronous Plugins permalink</span></a>Avoid Asynchronous&nbsp;Plugins</h3> <p>This is something you can do today. If it&rsquo;s at all possible to make the&nbsp;plugins you pass in to Sass synchronous, you can use the <code>renderSync()</code> method&nbsp;which doesn&rsquo;t need fibers to go fast. This may require rewriting some&nbsp;existing plugins, but it will pay dividends&nbsp;immediately.</p> <h3 id=embedded-dart-sass> <a class=anchor href="#embedded-dart-sass"><span class=visuallyhidden>Embedded Dart Sass permalink</span></a>Embedded Dart&nbsp;Sass</h3> <p>While it&rsquo;s not ready for prime-time yet, the Sass team is working on a&nbsp;project called &ldquo;embedded Dart Sass&rdquo;. This involves running Dart Sass as a <em>subprocess</em>, rather than a library, and communicating with it using a special protocol.&nbsp;This provides several important improvements over the existing&nbsp;alternatives:</p> <ul> <li><p>Unlike running <code>sass</code> from the command line, this will still work with&nbsp;plugins like the webpack importer. In fact, we plan to match the existing&nbsp;JavaScript <span class=caps>API</span> as closely as possible. This will probably run asynchronous plugins <em>even faster</em> than synchronous&nbsp;ones.</p></li> <li><p>Unlike the existing <span class=caps>JS</span>-compiled version, this will use the Dart <span class=caps>VM.</span> Due to&nbsp;the more static nature of the Dart language, the Dart <span class=caps>VM</span> runs Sass&nbsp;substantially faster than Node.js, which will provide about a 2x speed improvement for&nbsp;large stylesheets.</p></li> </ul> <p>The Node.js host for Embedded Sass is still in active development, but&nbsp;there&rsquo;s <a href="https://www.npmjs.com/package/sass-embedded">a beta release</a> available (with minimal features) if you want to kick&nbsp;the tires.</p> <h3 id=worker-threads> <a class=anchor href="#worker-threads"><span class=visuallyhidden>Worker Threads permalink</span></a>Worker&nbsp;Threads</h3> <p>We&rsquo;ve explored the possibility of running the pure-<span class=caps>JS</span> Dart Sass in a&nbsp;Node.js worker thread. Worker threads work a bit like fibers in that they make&nbsp;it possible for synchronous code to wait for asynchronous callbacks to&nbsp;run. Unfortunately, they&rsquo;re also <em>extremely</em> restrictive about what sorts&nbsp;of information can be passed across the thread boundary, which makes it much&nbsp;harder to use them to wrap a complex <span class=caps>API</span> like&nbsp;Sass&rsquo;s.</p> <p>At the moment, the Sass team is focused on Embedded Sass, so we don&rsquo;t have&nbsp;the spare bandwidth to dive into worker threads as an alternative. That said,&nbsp;we&rsquo;d be happy to help a motivated user implement this. If you&rsquo;re interested,&nbsp;follow up on <a href="https://github.com/sass/dart-sass/issues/868">the GitHub issue</a>!</p> <h3 id=reanimating-node-fibers> <a class=anchor href="#reanimating-node-fibers"><span class=visuallyhidden>Reanimating node-fibers permalink</span></a>Reanimating&nbsp;<code>node-fibers</code> </h3> <p>There&rsquo;s one other potential solution, although it would take true dedication&nbsp;to turn into reality. It would in principle be possible to add a new <span class=caps>API</span> to <span class=caps>V8</span>&nbsp;that would <em>officially</em> support the hooks <code>node-fibers</code> needs to do its good&nbsp;work. This would allow the package to return gloriously to life and Sass to&nbsp;make <code>render()</code> fast on into the&nbsp;future.</p> <p>The Sass team has contacted both the <span class=caps>V8</span> team and the owner of <code>node-fibers</code>,&nbsp;and both of them are amenable to this idea in principle. While neither one has&nbsp;the time to see it through to completion themselves, they&rsquo;ve expressed&nbsp;willingness to help an engineer who&rsquo;s willing to give it a&nbsp;shot.</p> <p>This isn&rsquo;t a contribution for the faint of heart, though: it requires&nbsp;knowledge of C++, a willingness to learn at least the basics of the <code>node-fibers</code>&nbsp;codebase and <span class=caps>V8</span>&rsquo;s isolate APIs, and skills in both <span class=caps>API</span> design and human interaction&nbsp;to negotiate a stable <span class=caps>API</span> that will meet the needs of <code>node-fibers</code> <em>and</em> that&nbsp;the <span class=caps>V8</span> team feels comfortable committing to maintain. But if you&rsquo;re&nbsp;interested, please don&rsquo;t hesitate to <a href="mailto:nweiz@google.com">reach out</a>!</p> </div> <div class=sl-c-alert> <div aria-labelledby=release-nav class='sl-l-container sl-c-list-horizontal-wrapper'> <ul class=sl-l-grid--justify-center> <li id=release-nav> Текущие релизы: </li> <li> <span class=release-name><a href="/dart-sass">Dart Sass</a>&#32;<a href="https://github.com/sass/dart-sass/releases/tag/1.38.2">1.38.2</a></span> </li> <li> <span class=release-name><a href="/libsass">LibSass</a>&#32;<a href="https://github.com/sass/libsass/releases/tag/3.6.5">3.6.5</a></span> </li> <li> <span class=release-name><a href="/ruby-sass">Ruby Sass</a><span aria-label=coffin role=presentation> &#32; ⚰ </span></span> </li> <li class='sl-l-grid__column sl-l-large-grid__column--auto-size'> <a href="/implementation">Руководство по внедрению</a> </li> </ul> </div> </div> </main> <footer class='site-footer contentinfo' itemscope=itemscope itemtype='http://schema.org/WPFooter' role=contentinfo> <div class='sl-l-container sl-l-section'> <div class='sl-l-grid sl-l-grid--full sl-l-large-grid--fit sl-l-large-grid--center sl-l-large-grid--gutters'> <div class=sl-l-grid__column> <p>Sass &copy; 2006&ndash;2021 команда Sass и многочисленные участники. Он доступен для использования и модификации по <a href="https://github.com/sass/dart-sass/blob/master/LICENSE">лицензии MIT&nbsp;</a>.</p> <nav class=sl-c-list-horizontal-wrapper> <ul> <li><a href="https://github.com/sass">Sass на GitHub</a></li> <li><a href="https://github.com/w3ref/sass-site">Исходный код веб-сайта</a></li> <li><a href="/styleguide">Руководство по стилю</a></li> <li><a href="/community-guidelines">Рекомендации сообщества</a></li> </ul> </nav> </div> <div class='sl-l-grid__column sl-l-large-grid__column--auto-size sl-l-large-grid--justify-right'> <a class=twitter-follow-button data-show-count=false data-size=large href='https://twitter.com/SassCSS'> Следите за @SassCSS </a> <script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
</script> </div> </div> </div> </footer> <script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script> <script>
  docsearch({
    apiKey: 'a409ff5d6a2476083c1a8dd1f8c04ec5',
    indexName: 'sass-lang',
    inputSelector: 'input.search',
    transformData: function(hits) {
      var domain = window.location.origin + "/";
      hits.forEach(function(hit) {
        if (!hit.url.startsWith(domain)) {
          hit.url = hit.url.replace(/^https?:\/\/[^\/]+\//, domain);
        }
      });
      return hits;
    },
    debug: false
  });
</script> <script src="/assets/js/sass-b8cb06ab.js"></script> </body> </html>